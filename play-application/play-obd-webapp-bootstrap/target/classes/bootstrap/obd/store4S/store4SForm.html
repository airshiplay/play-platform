<link type="text/css" rel="stylesheet" href="bootstrap/vendor/plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css">
<link type="text/css" rel="stylesheet" href="bootstrap/vendor/plugins/select2/select2.min.css">
<link type="text/css" rel="stylesheet" href="//cdn.bootcss.com/bootstrap-fileinput/4.3.3/css/fileinput.min.css">

<style>
.kv-logo .file-preview-frame, .kv-logo .file-preview-frame:hover {
	margin: 0;
	padding: 0;
	border: none;
	box-shadow: none;
	text-align: center;
}

.kv-logo .file-input {
	display: table-cell;
	max-width: 220px;
}
</style>
<section class="content-header">
	<h1>
		4S店列表 <small>开始管理4S店</small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="#page/center/home"><i class="fa fa-home"></i> Home</a></li>
		<li><a href="#page/obd/store4S/store4SList"><i class="glyphicon glyphicon-list"></i> 4S店列表</a></li>
		<li class="active" th:text="${store4S==null?'新建4S店':'编辑4S店'}">新建4S店</li>
	</ol>
</section>
<!-- Main content -->
<section class="content" th:inline="text">

	<div class="row">
		<div class="col-xs-12">

			<div class="box box-primary">
				<div class="box-header with-border">
					<h3 class="box-title" th:text="${store4S==null?'新建4S店':'编辑4S店'}">新建4S店</h3>
				</div>
				<!-- /.box-header -->
				<!-- form start -->
				<form role="form" class="store4s-form" action="/obd/store4S/save">
					<input type="hidden" name="id" th:value="${store4S==null?'':store4S.id}" />
					<input type="hidden" name="lng" id="lngInput" th:value="${store4S==null?'':store4S.lng}"/>
		            <input type="hidden" name="lat" id="latInput" th:value="${store4S==null?'':store4S.lat}"/>
					<div class="box-body">
						<div class="form-group">
							<label for="nameInput">4S店名称</label>
							<input type="text" name="name" class="form-control" id="nameInput" placeholder="请填写4S店名称"
								data-bv-stringlength="true" data-bv-stringlength-min="2" data-bv-stringlength-max="50" data-bv-stringlength-message="个数必须在2和50之间"
								
		                  		th:value="${store4S==null?'':store4S.name}"/>
						</div>
						<div class="form-group">
							<label for="logoInput">LOGO</label>
							<div class="kv-logo">
								<input name="logo" type="hidden" th:value="${store4S==null?'':store4S.logo}" >
								<input id="logoInput" name="file" type="file" class="file-loading">
							</div>
						</div>	
						<div class="form-group">
							<label for="phoneInput">电话</label>
							<input type="text" name="phone" class="form-control" id="phoneInput" placeholder="请填写电话"
								data-bv-stringlength="true" data-bv-stringlength-min="0" data-bv-stringlength-max="200" data-bv-stringlength-message="个数必须在0和200之间"
		                  		th:value="${store4S==null?'':store4S.phone}"/>
						</div>
						<div class="form-group">
							<label for="addressInput">地址</label>
							<input type="text" name="address" class="form-control" id="addressInput" placeholder="请填写地址"
								data-bv-stringlength="true" data-bv-stringlength-min="0" data-bv-stringlength-max="200" data-bv-stringlength-message="个数必须在0和200之间"
		                  		th:value="${store4S==null?'':store4S.address}"/>
						</div>
						<div class="form-group">
							<label for="addressInput">坐标设置</label>
							<input type="text" class="form-control" id="tipinput" placeholder="请输入地址进行搜索,右键设置位置" th:value="${store4S==null?'':store4S.address}"/>
						</div>
						
						<div id="map-container" style="height:300px;margin-top:-10px;">
						
						</div>
						
					</div>
					<!-- /.box-body -->

					<div class="box-footer">
						<button type="button" class="btn btn-default" onclick="location.href='#/page/obd/store4S/store4SList'">返回列表</button>
						<button type="submit" class="btn btn-primary pull-right">保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</section>

<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=d254ac4661b761ec170e42d7ffb9bdda&plugin=AMap.Autocomplete,AMap.PlaceSearch&callback=init"></script>
<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
<script>
function init(){    
    var map = null;
    if('[[${store4S==null?'':store4S.lng}]]'!=''){
    	var lng='[[${store4S==null?'':store4S.lng}]]';
    	var lat='[[${store4S==null?'':store4S.lat}]]';
    	map = new AMap.Map('map-container', {
    		 center: [lng, lat],
    	     resizeEnable: true,
    	     zoom: 12
    	});
    }else{
    	 map = new AMap.Map('map-container', {
    	        resizeEnable: true
    	 });
    }
    map.plugin(["AMap.ToolBar"], function() {
        map.addControl(new AMap.ToolBar());
    });
    var autoOptions = {
            input: "tipinput"
    };
    var auto = new AMap.Autocomplete(autoOptions);
    var placeSearch = new AMap.PlaceSearch({
        map: map
    });  //构造地点查询类
    AMap.event.addListener(auto, "select", select);//注册监听，当选中某条记录时会触发
    function select(e) {
        placeSearch.setCity(e.poi.adcode);
        placeSearch.search(e.poi.name);  //关键字查询查询
    }
    var contextMenu = new AMap.ContextMenu();  //创建右键菜单
    //右键添加Marker标记
    var lastMarker=null;//默认标记
    if('[[${store4S==null?'':store4S.lng}]]'!=''){
    	var lng='[[${store4S==null?'':store4S.lng}]]';
    	var lat='[[${store4S==null?'':store4S.lat}]]';
    	lastMarker = new AMap.Marker({
    	    position: [lng,lat],
    	    icon:base+"bootstrap/assets/img/map/mark_rs.png",
    	    map: map
    	});
    }
    
    contextMenu.addItem("设置为此位置", function(e) {
    	$("#lngInput").val(contextMenuPositon.lng);
    	$("#latInput").val(contextMenuPositon.lat);
    	if(lastMarker!=null){
    		lastMarker.setMap(null);
    	}
        var marker = new AMap.Marker({
            map: map,
            icon:base+"bootstrap/assets/img/map/mark_rs.png",
            position: contextMenuPositon //基点位置
        });
        lastMarker =marker;
    }, 3);
    //地图绑定鼠标右击事件——弹出右键菜单
    map.on('rightclick', function(e) {
        contextMenu.open(map, e.lnglat);
        contextMenuPositon = e.lnglat;
    });
}
</script>
<script type="text/javascript">
	require([ "domReady","datetimepickerzh","select2zh", "fileinputzh","kindeditor" ], function(domReady) {
		domReady(function() {
			activeMenu("obd_store4s_list");
			var $form = $(".store4s-form");
			/* $('#addressInput').on('input',function(event){  
			   
			});  */
			var userAvatar = '[[${store4S==null?'':store4S.logo}]]';
			$form.find("input[name=logo]").val(userAvatar);
			var $avatarInput = $("#logoInput");
			$avatarInput
					.fileinput(
							{
								overwriteInitial : true,
								language : "zh",
								uploadUrl : base
										+ "/center/multipart/upload",
								maxFileSize : 1500,
								showClose : false,
								showCaption : false,
								multiple : false,
								showUpload : false, // hide upload button
								showRemove : false, // hide remove button
								minFileCount : 1,
								maxFileCount : 1,
								elErrorContainer : '#kv-avatar-errors-1',
								msgErrorClass : 'alert alert-block alert-danger',
								defaultPreviewContent : userAvatar
										&& userAvatar != "" ? "<img src='"+userAvatar+"' alt='logo' style='width:160px'>"
										: "<img src='' alt='logo' style='width:160px'>",
								allowedFileTypes : [ "image" ]
							})
					.on("filebatchselected", function(event, files) {
						$avatarInput.fileinput("upload");
					})
					.on(
							'fileuploaded',
							function(event, data, previewId, index) {
								var form = data.form, files = data.files, extra = data.extra, response = data.response, reader = data.reader;
								if (response.success) {
									var $form = $(".store4s-form");
									$form
											.find("input[name=logo]")
											.val(
													KindEditor
															.formatUrl(
																	response.urls,
																	'absolute'));
								}
							});
			;
			$(".store4s-form").bootstrapValidator().on('success.form.bv', function(e) {
				e.preventDefault();
				var $form = $(e.target);
				var bv = $form.data('bootstrapValidator');
				
				if($("#lngInput").val()==null){
					$.alert({
						title : false,
						content : "请设置坐标位置",
						confirmButton : "关闭"
					});
					return ;
				}
				$.post($form.attr('action'), $form.serialize(), function(result) {
					if (result.success) {
						$.alert({
							title : false,
							closeIcon: true,
							content : "保存成功",
							confirmButton : "返回列表",
							confirm : function() {
								location.href = "#/page/obd/store4S/store4SList";
							}
						});

					} else {
						$.alert({
							title : false,
							content : result.msg,
							confirmButton : "关闭"
						});
						$form.bootstrapValidator('disableSubmitButtons', false);
					}
				}, 'json');
			});
		});
	});
</script>